import{_ as s,c as n,o as a,d as l}from"./app.ab098ea2.js";const E=JSON.parse('{"title":"算法","description":"","frontmatter":{},"headers":[{"level":2,"title":"diff算法","slug":"diff算法","link":"#diff算法","children":[{"level":3,"title":"diff 基础算法核心","slug":"diff-基础算法核心","link":"#diff-基础算法核心","children":[]},{"level":3,"title":"diff算法中的 vnode (手写步骤)","slug":"diff算法中的-vnode-手写步骤","link":"#diff算法中的-vnode-手写步骤","children":[]}]}],"relativePath":"zh-CN/guide/arithmetic.md","lastUpdated":1681891575000}'),p={name:"zh-CN/guide/arithmetic.md"},o=l(`<h1 id="算法" tabindex="-1">算法 <a class="header-anchor" href="#算法" aria-hidden="true">#</a></h1><h2 id="diff算法" tabindex="-1">diff算法 <a class="header-anchor" href="#diff算法" aria-hidden="true">#</a></h2><h3 id="diff-基础算法核心" tabindex="-1">diff 基础算法核心 <a class="header-anchor" href="#diff-基础算法核心" aria-hidden="true">#</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki dark-plus vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// 旧数据和新数据</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;"> = [{</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;b&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;h1&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;c&#39;</span><span style="color:#D4D4D4;">}],</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;"> = [{</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;b&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;c&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;d&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;e&#39;</span><span style="color:#D4D4D4;">}]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 存储下标 键值为 key值。类型 {[key: string | number]: number}</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">idxInOld</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 声明四个变量分别是，旧前指针变量、新前指针变量、旧后指针变量、新后指针变量</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 声明新旧节点变量</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]，</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 循环</span></span>
<span class="line"><span style="color:#C586C0;">while</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 匹配规则</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 先匹配旧前和新前</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 匹配旧后和新后</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 匹配旧前和新后</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 匹配旧后和新前</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 都不满足</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 判断是否存在 oldKeyToIdx， while 第一次循环是 oldKeyToIdx 是 undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;"> === </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 先获取所有旧数组中下标 用旧数组中 key 为键值 下标为数据值</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;"> = {}</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">; ++</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">key</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">] = </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 查找 oldKeyToIdx 旧 Key 中是否存在 newStartNode（新前节点）key</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">idxInOld</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">];</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">idxInOld</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 说明旧中没有新节点的key就创建</span></span>
<span class="line"><span style="color:#D4D4D4;">      ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 这一步是匹配新数组中某一项在旧数组中没有</span></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"><span style="color:#6A9955;">// 这一步是匹配旧数组中某一项在新数组中没有</span></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus vp-code-light" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// 旧数据和新数据</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;"> = [{</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;b&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;h1&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;c&#39;</span><span style="color:#D4D4D4;">}],</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;"> = [{</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;a&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;b&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;c&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;d&#39;</span><span style="color:#D4D4D4;">}, {</span><span style="color:#9CDCFE;">sel:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;div&#39;</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;e&#39;</span><span style="color:#D4D4D4;">}]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 存储下标 键值为 key值。类型 {[key: string | number]: number}</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">idxInOld</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 声明四个变量分别是，旧前指针变量、新前指针变量、旧后指针变量、新后指针变量</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 声明新旧节点变量</span></span>
<span class="line"><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]，</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 循环</span></span>
<span class="line"><span style="color:#C586C0;">while</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 匹配规则</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 先匹配旧前和新前</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 匹配旧后和新后</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 匹配旧前和新后</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">] == </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]) { </span><span style="color:#6A9955;">// 匹配旧后和新前</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldEndNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 都不满足</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 判断是否存在 oldKeyToIdx， while 第一次循环是 oldKeyToIdx 是 undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;"> === </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 先获取所有旧数组中下标 用旧数组中 key 为键值 下标为数据值</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;"> = {}</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">; ++</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">key</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldChildren</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">] = </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 查找 oldKeyToIdx 旧 Key 中是否存在 newStartNode（新前节点）key</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">idxInOld</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldKeyToIdx</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">];</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">idxInOld</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 说明旧中没有新节点的key就创建</span></span>
<span class="line"><span style="color:#D4D4D4;">      ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newStartNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newChildren</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 这一步是匹配新数组中某一项在旧数组中没有</span></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newStartIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"><span style="color:#6A9955;">// 这一步是匹配旧数组中某一项在新数组中没有</span></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldStartIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIndex</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    ... </span><span style="color:#6A9955;">// 逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h3 id="diff算法中的-vnode-手写步骤" tabindex="-1">diff算法中的 <code>vnode</code> (手写步骤) <a class="header-anchor" href="#diff算法中的-vnode-手写步骤" aria-hidden="true">#</a></h3><br><p><strong>1. 定义一个函数生成 <code>vnode</code> 数据结构</strong></p><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">[];</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]: </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[];</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;key&#39;</span><span style="color:#D4D4D4;">];</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 生成虚拟节点结构</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#6A9955;"> 虚拟节点数据</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#6A9955;"> 虚拟节点子集</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">text</span><span style="color:#6A9955;"> 虚拟节点内容</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">elm</span><span style="color:#6A9955;"> 真实节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * vnode(&#39;div&#39;, {key: &#39;a&#39;}, undefined, &#39;Hello World&#39;, undefined)</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">:</span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;"> = {}, </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">:</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;children&#39;</span><span style="color:#D4D4D4;">]  = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;text&#39;</span><span style="color:#D4D4D4;">] = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">:</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;elm&#39;</span><span style="color:#D4D4D4;">] = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">key</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus vp-code-light" tabindex="0"><code><span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">[];</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  [</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]: </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[];</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;key&#39;</span><span style="color:#D4D4D4;">];</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 生成虚拟节点结构</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#6A9955;"> 虚拟节点数据</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#6A9955;"> 虚拟节点子集</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">text</span><span style="color:#6A9955;"> 虚拟节点内容</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">elm</span><span style="color:#6A9955;"> 真实节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * vnode(&#39;div&#39;, {key: &#39;a&#39;}, undefined, &#39;Hello World&#39;, undefined)</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">:</span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;"> = {}, </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">:</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;children&#39;</span><span style="color:#D4D4D4;">]  = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;text&#39;</span><span style="color:#D4D4D4;">] = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">:</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;elm&#39;</span><span style="color:#D4D4D4;">] = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">key</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><strong>2. 定义一个 h 函数通过传参生成 <code>vnode</code> 数据结构</strong></p><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * h 函数</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@author</span><span style="color:#6A9955;">: peng-xiao-shuai</span></span>
<span class="line"><span style="color:#6A9955;"> * @date: 2023-03-30 12:26:14</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@last</span><span style="color:#6A9955;"> Modified by: peng-xiao-shuai</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@last</span><span style="color:#6A9955;"> Modified time: 2023-03-30 12:26:14</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNodeData</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;./vnode&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">type</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNodeElem</span><span style="color:#D4D4D4;"> = </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">boolean</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">null</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">undefined</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">type</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNodeContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#4EC9B0;">VNodeElem</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">VNodeElem</span><span style="color:#D4D4D4;">[]</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;)</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeData}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#6A9955;"> 虚拟节点数据</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, {key: &#39;1&#39;})</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeContent}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">content</span><span style="color:#6A9955;"> 虚拟节点内容数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, &#39;Hello World&#39;)</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, [&#39;Hello World&#39;, 1, h(&#39;span&#39;, 1)])</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">content</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeContent</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeData}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#6A9955;"> 虚拟节点数据</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeContent}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">content</span><span style="color:#6A9955;"> 虚拟节点内容数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, {key: &#39;1&#39;}, &#39;Hello World&#39;)</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">content</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeContent</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> == </span><span style="color:#CE9178;">&#39;&#39;</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">console</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">error</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">\`sel 不能为 &quot;&quot;\`</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;"> = {},</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;children&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;text&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;elm&#39;</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;">    if 判断是否对象并且不为 null</span></span>
<span class="line"><span style="color:#6A9955;">      if 判断是否是数组</span></span>
<span class="line"><span style="color:#6A9955;">        数组类型直接赋值给 children = d</span></span>
<span class="line"><span style="color:#6A9955;">      else if 是否存在 sel（标签）参数</span></span>
<span class="line"><span style="color:#6A9955;">        存在说明是 VNodeContent 类型 children = [d]</span></span>
<span class="line"><span style="color:#6A9955;">      else 否则则是 直接赋值给 data = d</span></span>
<span class="line"><span style="color:#6A9955;">    else 不是对象则赋值给 text = d</span></span>
<span class="line"><span style="color:#6A9955;">    */</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">typeof</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;"> == </span><span style="color:#CE9178;">&#39;object&#39;</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">Array</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">isArray</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">)) {  </span><span style="color:#6A9955;">// 满足说明 d 是 VNodeContent 类型</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">){ </span><span style="color:#6A9955;">// 满足说明 d 是 VNodeContent 类型否则就是 VNodeData</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = [</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// d 是内容</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">typeof</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> == </span><span style="color:#CE9178;">&#39;object&#39;</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">Array</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">isArray</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;">)) {  </span><span style="color:#6A9955;">// 满足说明 c 是 VNodeContent 类型</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">c</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 满足说明 c 是 VNodeContent</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = [</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// c 是内容</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">c</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 此时的 children 可能为 (number | string | object)[]</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">in</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">typeof</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">] !== </span><span style="color:#CE9178;">&#39;object&#39;</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">] = </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, {}, </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">] </span><span style="color:#C586C0;">as</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus vp-code-light" tabindex="0"><code><span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * h 函数</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@author</span><span style="color:#6A9955;">: peng-xiao-shuai</span></span>
<span class="line"><span style="color:#6A9955;"> * @date: 2023-03-30 12:26:14</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@last</span><span style="color:#6A9955;"> Modified by: peng-xiao-shuai</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@last</span><span style="color:#6A9955;"> Modified time: 2023-03-30 12:26:14</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNodeData</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;./vnode&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">type</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNodeElem</span><span style="color:#D4D4D4;"> = </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">boolean</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">null</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">undefined</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">type</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNodeContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#4EC9B0;">VNodeElem</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">VNodeElem</span><span style="color:#D4D4D4;">[]</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;)</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeData}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#6A9955;"> 虚拟节点数据</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, {key: &#39;1&#39;})</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeContent}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">content</span><span style="color:#6A9955;"> 虚拟节点内容数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, &#39;Hello World&#39;)</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, [&#39;Hello World&#39;, 1, h(&#39;span&#39;, 1)])</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">content</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeContent</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#6A9955;"> 标签名称</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeData}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#6A9955;"> 虚拟节点数据</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNodeContent}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">content</span><span style="color:#6A9955;"> 虚拟节点内容数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * h(&#39;div&#39;, {key: &#39;1&#39;}, &#39;Hello World&#39;)</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">content</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">VNodeContent</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">function</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">h</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;">?: </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> == </span><span style="color:#CE9178;">&#39;&#39;</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">console</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">error</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">\`sel 不能为 &quot;&quot;\`</span><span style="color:#D4D4D4;">);</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;"> = {},</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;children&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;text&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[</span><span style="color:#CE9178;">&#39;elm&#39;</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;">    if 判断是否对象并且不为 null</span></span>
<span class="line"><span style="color:#6A9955;">      if 判断是否是数组</span></span>
<span class="line"><span style="color:#6A9955;">        数组类型直接赋值给 children = d</span></span>
<span class="line"><span style="color:#6A9955;">      else if 是否存在 sel（标签）参数</span></span>
<span class="line"><span style="color:#6A9955;">        存在说明是 VNodeContent 类型 children = [d]</span></span>
<span class="line"><span style="color:#6A9955;">      else 否则则是 直接赋值给 data = d</span></span>
<span class="line"><span style="color:#6A9955;">    else 不是对象则赋值给 text = d</span></span>
<span class="line"><span style="color:#6A9955;">    */</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">typeof</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;"> == </span><span style="color:#CE9178;">&#39;object&#39;</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">Array</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">isArray</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">)) {  </span><span style="color:#6A9955;">// 满足说明 d 是 VNodeContent 类型</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">){ </span><span style="color:#6A9955;">// 满足说明 d 是 VNodeContent 类型否则就是 VNodeData</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = [</span><span style="color:#9CDCFE;">d</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// d 是内容</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">d</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">typeof</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> == </span><span style="color:#CE9178;">&#39;object&#39;</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">Array</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">isArray</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;">)) {  </span><span style="color:#6A9955;">// 满足说明 c 是 VNodeContent 类型</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">c</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 满足说明 c 是 VNodeContent</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = [</span><span style="color:#9CDCFE;">c</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// c 是内容</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">c</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 此时的 children 可能为 (number | string | object)[]</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">in</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">typeof</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">] !== </span><span style="color:#CE9178;">&#39;object&#39;</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">] = </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, {}, </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">] </span><span style="color:#C586C0;">as</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">any</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><strong>3. 定义一个创建虚拟节点转换函数 <code>elemToVNode</code> （作用：将真实节点转换虚拟节点</strong></p><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNodeData</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 类型保护</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">isElement</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">): </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">is</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 真实节点转换虚拟节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Node}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * elemToVNode(document.getElementById(&quot;app&quot;)!)</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">elemToVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[] | </span><span style="color:#4EC9B0;">undefined</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;">// 虚拟节点子集</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 对子集数据操作</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;"> = []</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">of</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 标签节点进行再次判断</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 标签节点下存在文字时 标签节点下将会有一个text子节点，这种情况下子节点将不需要，值直接放在 text中</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">((&lt;</span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;">&gt;</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">).</span><span style="color:#9CDCFE;">tagName</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">toLowerCase</span><span style="color:#D4D4D4;">(), {}, </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">trim</span><span style="color:#D4D4D4;">(), </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">        } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 递归函数</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">elemToVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">)!)</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">trim</span><span style="color:#D4D4D4;">() != </span><span style="color:#CE9178;">&#39;&#39;</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 文本节点直接添加到子集数组中</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, {}, </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">trim</span><span style="color:#D4D4D4;">(), </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// console.log(&#39;其他类型或者值为空&#39;, element.nodeType, element.nodeValue);</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 对当前 node 进行操作</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isElement</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">)) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 获取标签名和id、class属性</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">tagName</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">toLowerCase</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">data</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;"> = {}</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">cl</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">getAttribute</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;class&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 获取id</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// sel += &#39;#&#39; + node.id</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 获取class名称</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">cl</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// sel += &quot;.&quot; + cl.split(&quot; &quot;).join(&quot;.&quot;)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">cl</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">split</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39; &#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      {},</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&#39;&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      {},</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus vp-code-light" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNodeData</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">// 类型保护</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">isElement</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">): </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">is</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 真实节点转换虚拟节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Node}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * elemToVNode(document.getElementById(&quot;app&quot;)!)</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">elemToVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[] | </span><span style="color:#4EC9B0;">undefined</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;">// 虚拟节点子集</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 对子集数据操作</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;"> = []</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">of</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 标签节点进行再次判断</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 标签节点下存在文字时 标签节点下将会有一个text子节点，这种情况下子节点将不需要，值直接放在 text中</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">((&lt;</span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;">&gt;</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">).</span><span style="color:#9CDCFE;">tagName</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">toLowerCase</span><span style="color:#D4D4D4;">(), {}, </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">childNodes</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">].</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">trim</span><span style="color:#D4D4D4;">(), </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">        } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 递归函数</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">elemToVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">)!)</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeType</span><span style="color:#D4D4D4;"> == </span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">trim</span><span style="color:#D4D4D4;">() != </span><span style="color:#CE9178;">&#39;&#39;</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 文本节点直接添加到子集数组中</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">push</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, {}, </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">element</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">trim</span><span style="color:#D4D4D4;">(), </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// console.log(&#39;其他类型或者值为空&#39;, element.nodeType, element.nodeValue);</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 对当前 node 进行操作</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isElement</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">)) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 获取标签名和id、class属性</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">tagName</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">toLowerCase</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">data</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNodeData</span><span style="color:#D4D4D4;"> = {}</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">cl</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">getAttribute</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39;class&#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 获取id</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// sel += &#39;#&#39; + node.id</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 获取class名称</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">cl</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// sel += &quot;.&quot; + cl.split(&quot; &quot;).join(&quot;.&quot;)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">cl</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">split</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39; &#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">vNodeChildren</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      {},</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">nodeValue</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">vnode</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&#39;&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      {},</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">node</span></span>
<span class="line"><span style="color:#D4D4D4;">    )</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><strong>4. 定义一个创建真实节点转换函数 <code>createElem</code> （作用：将虚拟节点转换真实节点）</strong></p><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNodeData</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 虚拟节点创建真实节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">vnode</span><span style="color:#6A9955;"> 虚拟节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * createElem(h(&#39;div&#39;, {}, [&#39;1&#39;, h(&#39;span&#39;, &#39;span&#39;)]))</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{HTMLElement}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">HTMLElement</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">domNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">document</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">createElement</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">id</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">className</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">join</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39; &#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 递归将children改为真实节点</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">appendChild</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">appendChild</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">document</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">createTextNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">!))</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 这里直接使用 domNode.textContent</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">domNode</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus vp-code-light" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">VNodeData</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 虚拟节点创建真实节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">vnode</span><span style="color:#6A9955;"> 虚拟节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * createElem(h(&#39;div&#39;, {}, [&#39;1&#39;, h(&#39;span&#39;, &#39;span&#39;)]))</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{HTMLElement}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">HTMLElement</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">domNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">document</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">createElement</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">id</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">id</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">className</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">data</span><span style="color:#D4D4D4;">?.</span><span style="color:#9CDCFE;">class</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">join</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&#39; &#39;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 递归将children改为真实节点</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">appendChild</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">appendChild</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">document</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">createTextNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">!))</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 这里直接使用 domNode.textContent</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">domNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">vnode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">domNode</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><strong>5. 定义一个 patchVNode 函数 （作用：比较两个虚拟节点）</strong></p><ul><li>如果连个节点完全一样则退出函数</li><li>判断 <code>oldVNode.elm</code> 是否存在，没有则创建真实节点赋值给 <code>elm</code></li><li>将 <code>oldVNode.elm</code> 赋值给 <code>newVNode.elm</code></li><li>判断 <code>newVNode.text</code> 是否存在</li><li><ul><li>存在则将 <code>newVNode.text</code> 赋值给 <code>newVNode.elm.textContent</code></li></ul></li><li>否则继续判断（<code>else if</code>判断）旧节点和新节点是否都存在子集</li><li><ul><li>存在则进入 <code>diffVNode</code> 函数</li></ul></li><li>否则继续判断新节点是否存在子集</li><li><ul><li>存在将 <code>newVNode.elm</code> 清空（这里清空 <code>newVNode.elm</code> 是因为在上面，<code>newVNode.elm</code> 值是 <code>oldVNode.elm</code> 赋值的），在循环<code>newVNode.children</code> 给 <code>newVNode.elm</code> 添加子集</li></ul></li><li><code>else</code> 以上都不满足则进入文字替换，将 <code>newVNode.text</code> 赋值给 <code>newVNode.elm.textContent</code></li></ul><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus has-diff vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">createElem</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./transform&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;"> = &lt;</span><span style="color:#4EC9B0;">T</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">val</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">T</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">val</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 比较虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#6A9955;"> 旧的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#6A9955;"> 新的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;"> === </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 一样直接退出</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (!</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 避免oldVNode.elm 不存在的情况</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">)) {  </span><span style="color:#6A9955;">// 是否有text存在则将旧节点的textContent替换</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">) &amp;&amp; </span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 都存在子集交给diff去判断</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#DCDCAA;">diffVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧节点不存在子集 新节点存在，添加子集</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#CE9178;">&#39;&#39;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">elem</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">appendChild</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">elem</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">    })</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 文字替换</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus has-diff vp-code-light" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">createElem</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./transform&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;"> = &lt;</span><span style="color:#4EC9B0;">T</span><span style="color:#D4D4D4;">&gt;(</span><span style="color:#9CDCFE;">val</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">T</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">val</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 比较虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#6A9955;"> 旧的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#6A9955;"> 新的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;"> === </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 一样直接退出</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (!</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// 避免oldVNode.elm 不存在的情况</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">)) {  </span><span style="color:#6A9955;">// 是否有text存在则将旧节点的textContent替换</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">) &amp;&amp; </span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 都存在子集交给diff去判断</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#DCDCAA;">diffVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">isDef</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧节点不存在子集 新节点存在，添加子集</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#CE9178;">&#39;&#39;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">children</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">elem</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!.</span><span style="color:#DCDCAA;">appendChild</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">elem</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">    })</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 文字替换</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">textContent</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">text</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><strong>6. 定义一个 <code>diffVNode</code> 函数（也就是 <code>diff</code> 算法，去比较子节点，结合 <code>diff</code> 基础核心进行阅读）</strong></p><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus has-diff vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// 我这里是将 diffVNode、patch、patchVNode、sameVnode、isDef、isVNode放在一个函数所以，没有使用import</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * diff 节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Node}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#6A9955;"> oldCh数组的父级真实节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{(VNode|undefined)[]}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#6A9955;"> 旧的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode[]}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">newCh</span><span style="color:#6A9955;"> 新的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">diffVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">: (</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">|</span><span style="color:#4EC9B0;">undefined</span><span style="color:#D4D4D4;">)[], </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[]) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 定义指针</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 定义节点</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;">: {[</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;">]: </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;">} = {}</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">undefined</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">while</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧前undefined&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧前新前</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧前新前&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧后新后</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧后新后&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧前新后</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧前新后&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧后新前</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧后新前&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;都不满足&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// while 循环时第一次必定为 undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#D4D4D4;">((</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">index</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) </span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;">![</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">] = </span><span style="color:#9CDCFE;">index</span></span>
<span class="line"><span style="color:#D4D4D4;">        })</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> ? </span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">] : </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// sel 相同则不进行在创建标签</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">]!, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">        } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">), </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">] = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">), </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">before</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;"> + </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">] ? </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;"> + </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">].</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">! : </span><span style="color:#569CD6;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">]), </span><span style="color:#9CDCFE;">before</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">removeChild</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus has-diff vp-code-light" tabindex="0"><code><span class="line"><span style="color:#6A9955;">// 我这里是将 diffVNode、patch、patchVNode、sameVnode、isDef、isVNode放在一个函数所以，没有使用import</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * diff 节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Node}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#6A9955;"> oldCh数组的父级真实节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{(VNode|undefined)[]}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#6A9955;"> 旧的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{VNode[]}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">newCh</span><span style="color:#6A9955;"> 新的虚拟节点数组</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">diffVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">: (</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">|</span><span style="color:#4EC9B0;">undefined</span><span style="color:#D4D4D4;">)[], </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">[]) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 定义指针</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 定义节点</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">length</span><span style="color:#D4D4D4;"> - </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;">: {[</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;">]: </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;">} = {}</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">number</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">undefined</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">while</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧前undefined&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧前新前</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧前新前&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧后新后</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧后新后&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧前新后</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧前新后&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#569CD6;">null</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 旧后新前</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;旧后新前&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldEndVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[--</span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// console.log(&#39;都不满足&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;"> == </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// while 循环时第一次必定为 undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">forEach</span><span style="color:#D4D4D4;">((</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">index</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span><span style="color:#D4D4D4;">) </span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;">![</span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">] = </span><span style="color:#9CDCFE;">index</span></span>
<span class="line"><span style="color:#D4D4D4;">        })</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> ? </span><span style="color:#9CDCFE;">oldKeyMap</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;">] : </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;">) { </span><span style="color:#6A9955;">// sel 相同则不进行在创建标签</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">]!, </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!, </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">        } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">          </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">), </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">oldInIdx</span><span style="color:#D4D4D4;">] = </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">      } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;">), </span><span style="color:#9CDCFE;">oldStartVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">newStartVNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[++</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">before</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;"> + </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">] ? </span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;"> + </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">].</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">! : </span><span style="color:#569CD6;">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">newStartIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">newEndIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">]), </span><span style="color:#9CDCFE;">before</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> (</span><span style="color:#569CD6;">let</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldStartIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;"> &lt;= </span><span style="color:#9CDCFE;">oldEndIdx</span><span style="color:#D4D4D4;">; </span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">++) {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">parentElm</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">removeChild</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldCh</span><span style="color:#D4D4D4;">[</span><span style="color:#9CDCFE;">i</span><span style="color:#D4D4D4;">]?.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!)</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><strong>7. 定义 <code>patch</code> 函数去比较传入的值 （ <code>patch</code> 函数接收两个参数，一个旧节点，一个新节点）</strong></p><p><code>patch</code> 函数逻辑</p><ul><li>如果旧节点参数是真实节点，则将真实节点转换为虚拟节点 （当旧节点和新节点都是虚拟节点时去比较两个节点不同）</li></ul><p><em><code>oldNode newNode</code> 都是虚拟节点后：</em></p><ul><li>两个节点一样时（简单判断的话可以判断两个节点的 <code>sel</code> 和 <code>key</code> 是否相等,相等则一样） 节点一样将旧节点的elm赋值给新节点的elm属性，在执行 <code>patchVNode</code> 函数</li><li><code>else</code> 给 <code>newNode.elm</code> 赋值真实节点（真实节点由 <code>createElem(newVNode)</code> 创建），通过旧节点获取父级节点在通过父级节点的 <code>insertBefore</code> 函数将新节点移动到旧节点位置，在删除旧节点。</li></ul><p><em>return <code>newNode.elm</code> （ <code>elm</code> 为真实节点）</em></p><details><summary>展开查看</summary><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki dark-plus vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">createElem</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">elemToVNode</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./transform&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">isSel</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">isKey</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">isSel</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">isKey</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">isVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">): </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">is</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> (&lt;</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">&gt;</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">).</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 替换节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Element | Node | VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#6A9955;"> 旧节点(如果旧节点为虚拟节点，那么旧节点将不会渲染到页面)</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#6A9955;"> 新虚拟节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * patch(document.getElementById(&quot;app&quot;)!, h(&#39;h1&#39;, {id: &#39;a&#39;}, 121))</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Node}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">patch</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (!</span><span style="color:#DCDCAA;">isVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">)) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">elemToVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 创建新节点</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">oldElm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 标签 和 key 相同情况</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldElm</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 不同直接删除和新增节点</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// console.log(&#39;标签或key不同&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 将新节点移动到旧节点位置</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">parentNode</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">parentNode</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">removeChild</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><pre class="shiki dark-plus vp-code-light" tabindex="0"><code><span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">createElem</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">elemToVNode</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./transform&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#C586C0;">import</span><span style="color:#D4D4D4;"> { </span><span style="color:#9CDCFE;">VNode</span><span style="color:#D4D4D4;"> } </span><span style="color:#C586C0;">from</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./vnode&quot;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">) </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">isSel</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">sel</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">isKey</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> == </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">key</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">isSel</span><span style="color:#D4D4D4;"> &amp;&amp; </span><span style="color:#9CDCFE;">isKey</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">isVNode</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">): </span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">is</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> (&lt;</span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">&gt;</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;">).</span><span style="color:#9CDCFE;">sel</span><span style="color:#D4D4D4;"> !== </span><span style="color:#569CD6;">undefined</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"><span style="color:#6A9955;">/**</span></span>
<span class="line"><span style="color:#6A9955;"> * 替换节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Element | Node | VNode}</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#6A9955;"> 旧节点(如果旧节点为虚拟节点，那么旧节点将不会渲染到页面)</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@param</span><span style="color:#6A9955;"> </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#6A9955;"> 新虚拟节点</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@example</span></span>
<span class="line"><span style="color:#6A9955;"> * patch(document.getElementById(&quot;app&quot;)!, h(&#39;h1&#39;, {id: &#39;a&#39;}, 121))</span></span>
<span class="line"><span style="color:#6A9955;"> * </span><span style="color:#569CD6;">@returns</span><span style="color:#6A9955;"> </span><span style="color:#4EC9B0;">{Node}</span></span>
<span class="line"><span style="color:#6A9955;"> */</span></span>
<span class="line"><span style="color:#C586C0;">export</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">patch</span><span style="color:#D4D4D4;"> = (</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">Element</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;"> | </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">: </span><span style="color:#4EC9B0;">VNode</span><span style="color:#D4D4D4;">): </span><span style="color:#4EC9B0;">Node</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">=&gt;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (!</span><span style="color:#DCDCAA;">isVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">)) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">elemToVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 创建新节点</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">oldElm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> (</span><span style="color:#DCDCAA;">sameVnode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">)) { </span><span style="color:#6A9955;">// 标签 和 key 相同情况</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#9CDCFE;">oldElm</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#DCDCAA;">patchVNode</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldNode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  } </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> { </span><span style="color:#6A9955;">// 不同直接删除和新增节点</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// console.log(&#39;标签或key不同&#39;);</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createElem</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 将新节点移动到旧节点位置</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">parentNode</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">insertBefore</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">parentNode</span><span style="color:#D4D4D4;">?.</span><span style="color:#DCDCAA;">removeChild</span><span style="color:#D4D4D4;">(</span><span style="color:#9CDCFE;">oldElm</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">newVNode</span><span style="color:#D4D4D4;">.</span><span style="color:#9CDCFE;">elm</span><span style="color:#D4D4D4;">!</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre></div></details><p><code>vnode</code> 新老节点完全替换规则</p><ol><li>没有 <code>key</code> 并且 <code>sel 标签</code> 不同则暴力删除和新增</li></ol>`,28),D=[o];function e(c,t,r,y,C,d){return a(),n("div",null,D)}const F=s(p,[["render",e]]);export{E as __pageData,F as default};
